<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Match Up | Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <style>
        .glassy-form {
            display: flex;
            align-items: stretch;
            gap: 0;
            max-width: 100%;
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 14px;
            background: rgba(255,255,255,0.18);
            border: 1px solid rgba(255,255,255,0.35);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .glassy-input, .glassy-select {
            flex: 1 1 0;
            min-width: 0;
            padding: 0.7rem 0.9rem;
            border: none;
            border-right: 1px solid rgba(255,255,255,0.35);
            background: transparent;
            color: #fff;
            outline: none;
        }
        .glassy-input::placeholder { color: rgba(255,255,255,0.85); }
        .glassy-select option { color: #333; }
        .glassy-button {
            padding: 0.7rem 1rem;
            border: none;
            background: rgba(255,255,255,0.25);
            color: #fff;
            cursor: pointer;
            white-space: nowrap;
            border-left: 1px solid rgba(255,255,255,0.35);
        }
        .glassy-form > :first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .glassy-form > :last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        .glassy-button:hover { background: rgba(255,255,255,0.35); }
        @media (max-width: 768px) {
            .glassy-form {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.6rem;
            }
            .glassy-input, .glassy-select, .glassy-button {
                border-right: none;
                width: 100%;
                padding: 0.65rem 0.85rem;
            }
            .glassy-form > :first-child, .glassy-form > :last-child {
                border-radius: 10px;
            }
        }
        @media (max-width: 480px) {
            .glassy-input, .glassy-select, .glassy-button {
                padding: 0.6rem 0.8rem;
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>

    <custom-navbar></custom-navbar>
    
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">Find Your Dream Job</h1>
            <p class="hero-subtitle">Discover opportunities that match your skills and aspirations</p>
            <form id="heroSearchForm" class="glassy-form">
                <input type="text" id="hero_title" class="glassy-input" placeholder="Title">
                <input type="text" id="hero_location" class="glassy-input" placeholder="Location">
                <select id="hero_category" class="glassy-select" aria-label="Category">
                    <option value="">Category</option>
                    <option value="Construction Worker">Construction Worker</option>
                    <option value="Karpintero">Karpintero</option>
                    <option value="Tubero">Tubero</option>
                    <option value="Elektrisyan">Elektrisyan</option>
                    <option value="Mekaniko (Sasakyan o Motor)">Mekaniko (Sasakyan o Motor)</option>
                    <option value="Kasambahay / Yaya">Kasambahay / Yaya</option>
                    <option value="Tagalinis / Housekeeper">Tagalinis / Housekeeper</option>
                    <option value="Drayber (Family Driver / Delivery Driver)">Drayber (Family Driver / Delivery Driver)</option>
                    <option value="Tindero / Tindera">Tindero / Tindera</option>
                    <option value="Tagapagturo / Tutor">Tagapagturo / Tutor</option>
                    <option value="Aricon Technician">Aricon Technician</option>
                    <option value="Others">Others</option>
                </select>
                <input type="number" id="hero_min_salary" class="glassy-input" placeholder="Min Salary" step="0.01">
                <input type="number" id="hero_max_salary" class="glassy-input" placeholder="Max Salary" step="0.01">
                <select aria-label="Work Type" id="hero_work_type" class="glassy-select">
                    <option value="">Work Type</option>
                    <option value="Remote">Remote</option>
                    <option value="Onsite">Onsite</option>
                    <option value="Hybrid">Hybrid</option>
                </select>
                <button type="submit" class="glassy-button">Search</button>
            </form>
            <a href="#job-grid" class="cta-button" style="margin-top:0.5rem;">View All</a>
        </div>
    </section>
    
    <main>
        <div class="container">
            <h2 class="text-center mb-3" id="job-grid">Available Jobs</h2>
            <job-grid></job-grid>
        </div>
    </main>

    <custom-footer></custom-footer>


    <!-- Must be a module -->
     <script type="module" src="js/core/execute-ddl.js"></script>
    <script type="module" src="js/comp/navbar.js"></script>
    <script type="module" src="js/comp/job-card.js"></script>
    <script type="module" src="js/comp/job-grid.js"></script>
    <script type="module" src="js/comp/footer.js"></script>
    <script type="module" src="js/comp/job-details-seeker.js"></script>
    <script type="module" src="js/comp/job-details.js"></script>
    <script type="module">
        import { getJobsByFilter, getJobWithImagesByJobId } from './js/db-logic/job-handler.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('heroSearchForm');
            const grid = document.querySelector('job-grid');
            const userStr = localStorage.getItem('auth_user');
            let isSeeker = false;
            try { isSeeker = JSON.parse(userStr)?.role === 'job_seeker'; } catch {}
            const heroModal = document.createElement(isSeeker ? 'job-details-seeker' : 'job-details');
            heroModal.id = 'heroJobDetailsModal';
            document.body.appendChild(heroModal);

            function serializeSearchParams(p) {
                const params = new URLSearchParams();
                if (p.p_title) params.set('title', p.p_title);
                if (p.p_location) params.set('location', p.p_location);
                if (p.p_category) params.set('category', p.p_category);
                if (p.p_min_salary !== null && p.p_min_salary !== undefined) params.set('min_salary', String(p.p_min_salary));
                if (p.p_max_salary !== null && p.p_max_salary !== undefined) params.set('max_salary', String(p.p_max_salary));
                if (p.p_work_type) params.set('work_type', p.p_work_type);
                if (p.page) params.set('page', String(p.page));
                return params;
            }

            async function runSearchFromParams(p) {
                const p_limit = 12;
                const p_offset = 0;
                const r = await getJobsByFilter({
                    p_title: p.p_title ?? null,
                    p_location: p.p_location ?? null,
                    p_category: p.p_category ?? null,
                    p_min_salary: p.p_min_salary ?? null,
                    p_max_salary: p.p_max_salary ?? null,
                    p_work_type: p.p_work_type ?? null,
                    p_limit,
                    p_offset
                });
                if (!r.success) return;
                const jobs = [];
                for (const row of r.data) {
                    const id = row.id;
                    const det = await getJobWithImagesByJobId(id);
                    if (det.success && det.data) jobs.push(det.data);
                }
                if (grid) grid.data = jobs;
            }

            function readParams() {
                const params = new URLSearchParams(location.search);
                return {
                    p_title: params.get('title') || null,
                    p_location: params.get('location') || null,
                    p_category: params.get('category') || null,
                    p_min_salary: params.get('min_salary') ? parseFloat(params.get('min_salary')) : null,
                    p_max_salary: params.get('max_salary') ? parseFloat(params.get('max_salary')) : null,
                    p_work_type: params.get('work_type') || null,
                    page: params.get('page') ? parseInt(params.get('page'), 10) : null,
                    job: params.get('job') || null
                };
            }

            function prefillForm(p) {
                const t = document.getElementById('hero_title');
                const l = document.getElementById('hero_location');
                const c = document.getElementById('hero_category');
                const min = document.getElementById('hero_min_salary');
                const max = document.getElementById('hero_max_salary');
                const wt = document.getElementById('hero_work_type');
                if (t) t.value = p.p_title || '';
                if (l) l.value = p.p_location || '';
                if (c) c.value = p.p_category || '';
                if (min) min.value = p.p_min_salary !== null && p.p_min_salary !== undefined ? String(p.p_min_salary) : '';
                if (max) max.value = p.p_max_salary !== null && p.p_max_salary !== undefined ? String(p.p_max_salary) : '';
                if (wt) wt.value = p.p_work_type || '';
            }

            async function openJobById(id) {
                const res = await getJobWithImagesByJobId(id);
                if (res.success && res.data) {
                    heroModal.data = res.data;
                    heroModal.open();
                }
            }

            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const p_title = document.getElementById('hero_title').value.trim() || null;
                const p_location = document.getElementById('hero_location').value.trim() || null;
                const p_category = document.getElementById('hero_category').value || null;
                const minVal = document.getElementById('hero_min_salary').value;
                const maxVal = document.getElementById('hero_max_salary').value;
                const p_min_salary = minVal !== '' ? parseFloat(minVal) : null;
                const p_max_salary = maxVal !== '' ? parseFloat(maxVal) : null;
                const wtVal = document.getElementById('hero_work_type').value;
                const p_work_type = wtVal ? wtVal : null;
                const state = { p_title, p_location, p_category, p_min_salary, p_max_salary, p_work_type, page: 1 };
                const params = serializeSearchParams(state);
                history.pushState({ type: 'search', state }, '', `?${params.toString()}`);
                await runSearchFromParams(state);
                document.getElementById('job-grid')?.scrollIntoView({ behavior: 'smooth' });
            });

            document.addEventListener('view-job', async (e) => {
                const { jobId } = e.detail || {};
                const current = readParams();
                const params = serializeSearchParams(current);
                params.set('job', jobId);
                history.pushState({ type: 'modal', jobId }, '', `?${params.toString()}`);
                await openJobById(jobId);
            });

            heroModal.addEventListener('job-details-closed', () => {
                const s = history.state;
                if (s && s.type === 'modal') history.back();
            });

            document.addEventListener('page-changed', (e) => {
                const current = readParams();
                const state = { p_title: current.p_title, p_location: current.p_location, p_category: current.p_category, p_min_salary: current.p_min_salary, p_max_salary: current.p_max_salary, p_work_type: current.p_work_type, page: e.detail?.page || 1 };
                const params = serializeSearchParams(state);
                if (current.job) params.set('job', current.job);
                history.pushState({ type: 'search', state }, '', `?${params.toString()}`);
            });

            window.addEventListener('popstate', async () => {
                const p = readParams();
                prefillForm(p);
                if (p.p_title || p.p_location || p.p_category || p.p_min_salary !== null || p.p_max_salary !== null || p.p_work_type) {
                    await runSearchFromParams(p);
                } else if (grid && p.page) {
                    grid.setPage(p.page);
                }
                if (p.job) {
                    await openJobById(p.job);
                } else {
                    if (heroModal.isOpen && heroModal.isOpen()) heroModal.close();
                }
            });

            (async function init() {
                const p = readParams();
                prefillForm(p);
                if (p.p_title || p.p_location || p.p_category || p.p_min_salary !== null || p.p_max_salary !== null || p.p_work_type) {
                    await runSearchFromParams(p);
                } else if (grid && p.page) {
                    grid.setPage(p.page);
                }
                if (p.job) await openJobById(p.job);
            })();
        });
    </script>
</body>
</html>
